(function(){"use strict";angular.module("pdifferenceApp",["ngResource","ui.bootstrap"]).config(["$routeProvider",function(a){return a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}])}).call(this),function(){"use strict";var a={}.hasOwnProperty;angular.module("pdifferenceApp").controller("MainCtrl",["$scope","$injector",function(b,c){var d,e,f,g,h,i,j,k,l;f=c.get("$timeout"),g=c.get("$window"),d=c.get("$document"),e=c.get("$rootScope"),i=c.get("Session"),h=c.get("Modal"),b.dock={position:"left",pinned:!0,hidden:!1},b.uploader=new h,b.importer=new h,b.diffModal=new h,b.groupModal=new h,b.screenShotModal=new h,b.configModal=new h,b.alerts=[],b.getAlertById=function(a){return _.find(b.alerts,function(b){return b._id===a})},b.removeAlert=function(a){return _.pull(b.alerts,b.getAlertById(a))},b.updateAlertProgress=function(a,c){var d;return d=b.getAlertById(a),d?d.progressPercent=c:void 0},b.addAlert=function(a){return a._id=_.uniqueId(),b.alerts.push(a),a._id},b.broadcast=function(){return e.$broadcast.apply(this,arguments)},b.changeSession=function(a){return b.activeSession=a},b.onScrollTop=function(){return g.scrollTo(0,0)},b.onScrollBottom=function(){return g.scrollTo(0,d[0].body.scrollHeight)},b.sessions=[new i],b.setActiveSession=function(a){return b.activeSession=a},b.setActiveSession(b.sessions[0]),l={"ctrl+=":function(){return b.activeSession.viewport.zoom.increase()},"ctrl+-":function(){return b.activeSession.viewport.zoom.decrease()},"ctrl+alt+=":function(){return b.activeSession.viewport.zoom.increase(.02)},"ctrl+alt+-":function(){return b.activeSession.viewport.zoom.decrease(.02)},"ctrl+shift+d":function(){return b.dock.hidden=!b.dock.hidden},"ctrl+h":function(){return b.activeSession.currentShot.show=!b.activeSession.currentShot.show},"ctrl+backspace":function(){return b.activeSession.removeShot(b.activeSession.currentShot)},"ctrl+u":function(){return b.uploader.show()},"ctrl+d":function(){return b.diffModal.show()},"ctrl+s":function(){return b.screenShotModal.show()},"ctrl+e":function(){return b.activeSession["export"]()},"ctrl+i":function(){return b.importer.show()},"ctrl+f":function(){return b.activeSession.viewport.center()},"ctrl+shift+p":function(){return b.dock.pinned=!b.dock.pinned}};for(k in l)a.call(l,k)&&(j=l[k],l[k]=_.wrap(j,function(a,c){return c.preventDefault(),b.$apply(_.partial(a,c))}),Mousetrap.bindGlobal(k,l[k]));Mousetrap.bind(["ctrl+up","ctrl+k"],function(a){a.preventDefault(),b.$apply(function(){return b.activeSession.moveToShot(b.activeSession.getActiveSetIndex()-1)})}),Mousetrap.bind(["ctrl+down","ctrl+j"],function(a){return a.preventDefault(),b.$apply(function(){return b.activeSession.moveToShot(b.activeSession.getActiveSetIndex()+1)})})}])}.call(this),function(){angular.module("pdifferenceApp").controller("uploaderCtrl",["$scope","Shot",function(a,b){var c,d,e;a.uploadedFiles=[],a.imageUrls=[],a.onFileSelect=function(b){var c,d,e,f;for(f=[],d=0,e=b.length;e>d;d++)c=b[d],f.push(a.uploadedFiles.push(c));return f},d=function(b){var d,e;return e=new FileReader,d=a.addAlert({loading:!0,msg:"Loading image "+b.name}),e.onload=function(e){return a.removeAlert(d),c(e.target.result,b,"upload"),a.$apply()},e.readAsDataURL(b)},e=function(a){return c(a,{name:a},"link")},c=function(c,d,e){var f;return f=new b({type:e}),f.displayURL=d.name,f.path=c,a.activeSession.shots.push(f),a.activeSession.setCurrentShot(f),a.uploader.hide()},a.addUrl=function(){return a.imageUrl.length>0?(a.imageUrls.push(a.imageUrl),a.imageUrl=""):void 0},a.upload=function(){var b,c,f,g,h,i,j,k;for(j=a.uploadedFiles,f=0,h=j.length;h>f;f++)b=j[f],d(b);for(k=a.imageUrls,g=0,i=k.length;i>g;g++)c=k[g],e(c)},a.$watch("uploader.open",function(b){return b===!0?(a.uploadedFiles=[],a.imageUrls=[]):void 0})}])}.call(this),function(){angular.module("pdifferenceApp").controller("differenceCtrl",["$scope","$injector",function(a,b){var c,d,e;return c=b.get("$document"),d=b.get("Shot"),a.selectedShots=[],a.diffMode="block",a.ignoreColors=!1,a.tolerance={red:16,green:16,blue:16,minBrightness:16},e=function(){return a.activeSession.shots.forEach(function(a){return a.selectedForDifference=!1})},a.performDiff=function(){var b,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w;if(a.selectedShots=_.filter(a.activeSession.shots,function(a){return a.selectedForDifference}),a.selectedShots.length<2)return a.diffModal.throwError("Please select 2 or more images."),void 0;for(a.diffModal.hide(),j=a.addAlert({msg:"Performing difference...",loading:!0,progress:!0}),r=c[0].createElement("canvas"),u=4,v=0,o=0,h=[],l=Math.max.apply(Math,_.map(a.selectedShots,function(a){return 4*a.canvasContext.canvas.width*a.canvasContext.canvas.height})),p=l/u,k=Math.max.apply(Math,_.map(a.selectedShots,function(a){return a.canvasContext.canvas.height})),m=Math.max.apply(Math,_.map(a.selectedShots,function(a){return a.canvasContext.canvas.width})),e=k/u,r.height=k,r.width=m,s=r.getContext("2d"),g=w=0;u>=0?u>w:w>u;g=u>=0?++w:--w)t=new Worker("difference.js"),i=_.map(a.selectedShots,function(a){var b,c,d,f,h,i,j,k;return k=a.canvasContext.canvas.width,h=a.canvasContext.canvas.height,j=e*g,i=0,c=i-a.screenPosition.x,d=j-a.screenPosition.y,f=Math.round(k-(k-m)),b=e,{offset:a.screenPosition,data:a.canvasContext.getImageData(c,d,f,b),height:h,width:k,startX:i,startY:j,block:e}}),b=Math.max.apply(Math,_.pluck(i,"block")),q=Math.max.apply(Math,_.pluck(i,"startY")),f={contextData:s.getImageData(0,i[0].startY,r.width,b),imageData:i,startY:q,block:b,id:g,mode:a.diffMode,tolerance:a.tolerance,ignoreColors:a.ignoreColors},t.addEventListener("message",function(b){return"progress"===b.data.event?o=b.data.progress:"done"===b.data.event&&(v++,a.updateAlertProgress(j,100*(v/u)),h.push(b.data),v===u&&(n(h,k,m),a.removeAlert(j))),a.$apply()}),t.postMessage(f);return n=function(b,c,e){var f,g,h,i,j,k;for(b=b.sort(function(a,b){return a.id>b.id?1:a.id<b.id?-1:0}),h={numberOfSamePixels:0,numberOfDifferentPixels:0,totalPixels:0},angular.forEach(b,function(a){return h.numberOfSamePixels+=a.stats.numberOfSamePixels,h.numberOfDifferentPixels+=a.stats.numberOfDifferentPixels,h.totalPixels+=a.stats.totalPixels}),h.differenceRatio=h.numberOfDifferentPixels/h.totalPixels,r.width=e,r.height=c,g=r.getContext("2d"),j=0,k=b.length;k>j;j++)f=b[j],g.putImageData(f.data,0,f.y);return i=new d({path:r.toDataURL(),width:e,height:c,data:h}),a.activeSession.shots.push(i)}},a.$watch("diffModal.open",function(b){return b?(e(),a.activeSession.shots.length<2?a.diffModal.open=!1:void 0):(a.diffModal.showError=!1,a.selectedShots=[])}),a.$on("openDiffModal",function(){return a.diffModal.show()}),a.$on("closeDiffModal",function(){return a.diffModal.hide()})}])}.call(this),function(){angular.module("pdifferenceApp").controller("takeShotCtrl",["$scope","$window",function(a){var b;return a.userAgents={"Safari - 6.0":"Mozilla/5.0 (iPad; CPU OS 6_0 like Mac OS X) AppleWebKit/536.26 (KHTML, like Gecko) Version/6.0 Mobile/10A5355d Safari/8536.25","Internet Explorer 10":"Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.2; Trident/6.0)","Internet Explorer 9":"Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Trident/5.0)","Internet Explorer 8":"Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.0; Trident/4.0)","Internet Explorer 7":"Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 6.0)","Firefox 7 - Windows":"Mozilla/5.0 (Windows NT 6.1; Intel Mac OS X 10.6; rv:7.0.1) Gecko/20100101 Firefox/7.0.1","Firefox 7 - Mac":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.6; rv:7.0.1) Gecko/20100101 Firefox/7.0.1","Firefox 4 - Windows":"Mozilla/5.0 (Windows NT 6.1; rv:2.0.1) Gecko/20100101 Firefox/4.0.1","Firefox 4 - Mac":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.6; rv:2.0.1) Gecko/20100101 Firefox/4.0.1","Firefox 14 - Android Mobile":"Mozilla/5.0 (Android; Mobile; rv:14.0) Gecko/14.0 Firefox/14.0","Firefox 14 - Android Tablet":"Mozilla/5.0 (Android; Tablet; rv:14.0) Gecko/14.0 Firefox/14.0","Chrome - Android Mobile":"Mozilla/5.0 (Linux; Android 4.0.4; Galaxy Nexus Build/IMM76B) AppleWebKit/535.19 (KHTML, like Gecko) Chrome/18.0.1025.133 Mobile Safari/535.19","Chrome - Android Tablet":"Mozilla/5.0 (Linux; Android 4.1.2; Nexus 7 Build/JZ054K) AppleWebKit/535.19 (KHTML, like Gecko) Chrome/18.0.1025.166 Safari/535.19","Chrome 32":"Mozilla/5.0 (Windows NT 6.2; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/32.0.1667.0 Safari/537.36","iPhone - iOS 7":"Mozilla/5.0 (iPhone; CPU iPhone OS 7_0_2 like Mac OS X) AppleWebKit/537.51.1 (KHTML, like Gecko) Version/7.0 Mobile/11A4449d Safari/9537.53","iPhone - iOS 6":"Mozilla/5.0 (iPhone; CPU iPhone OS 6_0 like Mac OS X) AppleWebKit/536.26 (KHTML, like Gecko) Version/6.0 Mobile/10A5376e Safari/8536.25","iPad - iOS 7":"Mozilla/5.0 (iPad; CPU OS 7_0_2 like Mac OS X) AppleWebKit/537.51.1 (KHTML, like Gecko) Version/7.0 Mobile/11A501 Safari/9537.53A","iPad - iOS 6":"Mozilla/5.0 (iPad; CPU OS 6_0 like Mac OS X) AppleWebKit/536.26 (KHTML, like Gecko) Version/6.0 Mobile/10A5376e Safari/8536.25","Android 2.3 - Nexus S":"Mozilla/5.0 (Linux; U; Android 2.3.6; en-us; Nexus S Build/GRK39F) AppleWebKit/533.1 (KHTML, like Gecko) Version/4.0 Mobile Safari/533.1","Android 4.0.2 - Galaxy Nexus":"Mozilla/5.0 (Linux; U; Android 4.0.2; en-us; Galaxy Nexus Build/ICL53F) AppleWebKit/534.30 (KHTML, like Gecko) Version/4.0 Mobile Safari/534.30","Blackberry - Playbook 2.1":"Mozilla/5.0 (PlayBook; U; RIM Tablet OS 2.1.0; en-US) AppleWebKit/536.2+ (KHTML, like Gecko) Version/7.2.1.0 Safari/536.2+","Blackberry - 9900":"Mozilla/5.0 (BlackBerry; U; BlackBerry 9900; en-US) AppleWebKit/534.11+ (KHTML, like Gecko) Version/7.0.0.187 Mobile Safari/534.11+","Blackberry - BB10":"Mozilla/5.0 (BB10; Touch) AppleWebKit/537.1+ (KHTML, like Gecko) Version/10.0.0.1337 Mobile Safari/537.1+","MeeGo - Nokia N9":"Mozilla/5.0 (MeeGo; NokiaN9) AppleWebKit/534.13 (KHTML, like Gecko) NokiaBrowser/8.5.0 Mobile Safari/534.13"},a.viewports={Desktop:{width:1024,height:768,density:1},"Nexus 4":{width:768,height:1280,density:2},"Nexus 7":{width:1280,height:800,density:1.325},"iPhone 4":{width:640,height:960,density:2},"iPhone 5":{width:640,height:1136,density:2},"Galaxy Nexus 10":{width:2560,height:1600,density:2},"Apple iPad 3 / 4":{width:2084,height:1536,density:2},"Apple iPad 1 / 2 / Mini":{width:1024,height:768,density:1},"Samsung Galaxy Note 3":{width:1080,height:1920,density:2}},a.viewport=a.viewports.Desktop,a.urls=[],a.useDensity=!0,a.shot={url:"",options:{screenSize:{width:1024,height:768},shotSize:{width:"all",height:"all"},userAgent:a.userAgents["Chrome 32"]}},b=function(){var b;return b=a.useDensity?a.viewport.density:1,a.shot.options.screenSize.width=Math.round(a.viewport.width/b),a.shot.options.screenSize.height=Math.round(a.viewport.height/b),a.shot.options.shotSize.width=Math.round(a.viewport.width/b),a.shot.options.shotSize.height=Math.round(a.viewport.height/b)},a.$watch("viewport",b),a.$watch("useDensity",b),a.swapDimensions=function(){var b,c;return c=a.shot.options.screenSize.width,b=a.shot.options.screenSize.height,a.shot.options.screenSize.width=b,a.shot.options.screenSize.height=c,c=a.shot.options.shotSize.width,b=a.shot.options.shotSize.height,a.shot.options.shotSize.width=b,a.shot.options.shotSize.height=c},a.takeShot=function(){var b;return a.screenShotModal.hide(),b=a.addAlert({msg:"Taking screenshot...",loading:!0}),a.activeSession.socket.captureScreen(a.shot,function(){return a.removeAlert(b),a.$apply()}),a.shot.url=""}}])}.call(this),function(){angular.module("pdifferenceApp").controller("importCtrl",["$scope","$injector",function(a,b){var c,d,e;c=b.get("Session"),d=b.get("Shot"),a["import"]=function(b){var c,d,f;return a.importer.hide(),d=b[0],f=new FileReader,c=a.addAlert({loading:!0,msg:"Importing session "+d.name}),f.onload=function(b){return a.removeAlert(c),e(b.target.result)},f.readAsText(d)},e=function(b){return b=JSON.parse(b),b.shots=_.map(b.shots,function(a){return a.id=_.uniqueId(),new d(a)}),a.sessions.push(new c(b)),a.setActiveSession(a.sessions[a.sessions.length-1]),a.$apply()}}])}.call(this),function(){angular.module("pdifferenceApp").controller("configCtrl",["$scope",function(a){return a.config={},a.activeSession.socket.getConfig(function(b){return a.config=JSON.parse(b),a.$apply()}),a.saveConfig=function(){return a.activeSession.socket.saveConfig(a.config)}}])}.call(this),function(){angular.module("pdifferenceApp").directive("animateOpacity",["$parse",function(a){return function(b,c,d){var e;return e=a(d.animateTime),b.$watch(d.animateOpacity,function(a){var d;return a?(d=e(b),c.css("-webkit-animation","opacityAnim "+d+"s linear infinite")):c.css("-webkit-animation","none")})}}])}.call(this),function(){angular.module("pdifferenceApp").directive("bufferCanvas",["$parse",function(a){return function(b,c,d){var e,f,g,h,i;for(f=a(d.buffers)(b),c[0].width=a(d.pixelWidth)(b),c[0].height=a(d.pixelHeight)(b),g=c[0].getContext("2d"),h=0,i=f.length;i>h;h++)e=f[h],g.putImageData(e.data,0,e.y)}}])}.call(this),function(){angular.module("pdifferenceApp").directive("fileUpload",["$parse",function(a){return function(b,c,d){var e;return console.log("Hello"),e=a(d.fileUpload),c.bind("change",function(a){return b.$apply(function(){return e(b,{$event:a,$files:c[0].files})})})}}])}.call(this),function(){angular.module("pdifferenceApp").directive("controlSection",function(){return{restrict:"EA",link:function(a,b){var c;return c=b.find("label"),c.on("click",function(){return b[0].hasAttribute("hide")?b.removeAttr("hide"):b.attr("hide","")})}}})}.call(this),function(){angular.module("pdifferenceApp").directive("imageCanvas",["$parse",function(){return function(a,b,c){var d,e;return d=function(c){var d,f;return f=new Image,f.onload=function(){return a.$apply(function(){var c;return b.attr("width",f.width),b.attr("height",f.height),c=b[0].getContext("2d"),c.drawImage(f,0,0,f.width,f.height),a.shot.canvasContext=c,a.shot.width=f.width,a.shot.height=f.height,e(),a.removeAlert(d),(a.applyZoom||angular.noop)(),a.activeSession.viewport.adjust()})},d=a.addAlert({msg:"Loading image...",loading:!0}),f.src=c},e=function(){return a.shot.data.totalPixels=a.shot.height*a.shot.width},a.$watch(c.src,function(a){return d(a)})}}])}.call(this),function(){angular.module("pdifferenceApp").directive("slider",["$parse",function(a){return function(b,c,d){var e;return e=a(d.slider),c.bind("change",function(a){return b.$apply(function(){return e(b,{$event:a,$value:parseFloat(a.target.value,10)})})})}}])}.call(this),function(){angular.module("pdifferenceApp").directive("toolbelt",["$window",function(a){return{restrict:"A",link:function(b,c){var d,e,f,g,h;return d=!1,e=0,f=0,g=0,h=0,b.$watch("activeSession.toolbelt.active",function(a){return c.attr("tool",a)}),c.on("mousedown",function(b){return d=!0,e=b.clientX,f=b.clientY,g=a.pageXOffset,h=a.pageYOffset}),c.on("mouseup",function(){return d=!1}),c.on("mousemove",function(a){var c,i;if(d)switch(c=e-a.clientX,i=f-a.clientY,b.activeSession.toolbelt.active){case"move":b.activeSession.viewport.setPosition(g+c,h+i)}})}}}])}.call(this),function(){angular.module("pdifferenceApp").directive("zoom",function(){return{restrict:"A",link:function(a,b,c){a.applyZoom=function(c){return null==c&&(c=a.activeSession.viewport.zoom.level),b.css({"-webkit-transform":"scale("+c+")","-webkit-transform-origin":"0 0"})},a.$watch(c.zoom,a.applyZoom)}}})}.call(this),function(){angular.module("pdifferenceApp").filter("percent",function(){return function(a){return Math.round(1e4*parseFloat(a,10))/100+"%"}})}.call(this),function(){angular.module("pdifferenceApp").factory("Shot",function(){return Shot})}.call(this),function(){angular.module("pdifferenceApp").factory("Socket",["Shot","$document",function(a){var b,c;return c=angular.bind,b=function(){function b(a){this.session=a,this.connected=!1,this.io=io.connect("http://localhost"),this.io.on("send:onConnect",c(this,this.onConnect))}return b.prototype.onConnect=function(a){return this.connected=!0,console.log(a.message)},b.prototype.emit=function(a,b){return this.io.emit(a,b)},b.prototype.captureScreen=function(b,c){var d,e,f,g=this;return d="",f=b.url,this.takingShot=!0,e=function(d){return g.io.removeListener("data:end",e),g.session.addShot(new a({displayURL:f,path:d.data,width:b.shotWidth,height:b.shotHeight})),c()},this.io.emit("send:takeShot",b),this.io.on("data:end",e)},b.prototype.getConfig=function(a){var b,c=this;return b=function(b){return a(b),c.io.removeListener("data:config")},this.io.on("data:config",b),this.io.emit("send:getConfig")},b.prototype.saveConfig=function(a){return this.io.emit("send:saveConfig",a)},b}()}])}.call(this),function(){var a={}.hasOwnProperty,b=function(b,c){function d(){this.constructor=b}for(var e in c)a.call(c,e)&&(b[e]=c[e]);return d.prototype=c.prototype,b.prototype=new d,b.__super__=c.prototype,b};angular.module("pdifferenceApp").factory("Session",["$injector",function(a){var c,d,e,f,g,h;return g=a.get("Viewport"),f=a.get("Toolbelt"),e=a.get("Socket"),c=a.get("$document"),h=["id","name"],d=function(a){function d(a){Session.call(this,a),this.viewport=new g(this),this.toolbelt=new f(this),this.socket=new e(this)}return b(d,a),d.prototype["export"]=function(){var a,b,e,f;return b=d.__super__["export"].apply(this,arguments),f="data:application/json;charset=utf8,"+b,e=c[0].createElement("a"),e.href=f,e.download=""+this.name+".pdiffy",a=c[0].createEvent("Event"),a.initEvent("click",!0,!0),e.dispatchEvent(a)},d.prototype.removeShot=function(a){return d.__super__.removeShot.call(this,a),this.viewport.adjust()},d}(Session)}])}.call(this),function(){angular.module("pdifferenceApp").factory("Viewport",["$injector",function(a){var b,c,d;return b=a.get("$window"),d=function(){function a(a){this.viewport=a,this.level=1}return a.prototype.increase=function(a){return null==a&&(a=.1),this.level+=a,this.viewport.adjust()},a.prototype.decrease=function(a){return null==a&&(a=.1),this.level-=a,this.viewport.adjust()},a.prototype.reset=function(){return this.level=1,this.viewport.adjust()},a}(),c=function(){function a(a){this.session=a,this.left=0,this.top=0,this.width=0,this.height=0,this.canvasWidth=0,this.canvasHeight=0,this.zoom=new d(this)}return a.prototype.center=function(){var a,c,d,e,f,g,h;return null!==this.session.currentShot?(e=this.session.currentShot,c=e.screenPosition.x*this.zoom.level,d=e.screenPosition.y*this.zoom.level,f=e.width*this.zoom.level,a=e.height*this.zoom.level,g=this.left+c+(f-b.innerWidth)/2,h=this.top+d+(a-b.innerHeight)/2,this.setPosition(g,h)):void 0},a.prototype.setPosition=function(a,c){return null==a&&(a=b.pageXOffset),null==c&&(c=b.pageYOffset),b.scrollTo(a,c)},a.prototype.adjust=function(){var a,c,d;return d=this.session.shots.concat(this.session.differences),a=this.session.getMaxHeight(),c=this.session.getMaxWidth(),this.canvasWidth=c,this.canvasHeight=a,this.left=b.innerWidth-200,this.top=b.innerHeight-200,this.height=a*this.zoom.level+2*this.top,this.width=c*this.zoom.level+2*this.left},a}()}])}.call(this),function(){angular.module("pdifferenceApp").factory("Modal",function(){var a;return a=function(){function a(a){null==a&&(a={}),this.open=!1,this.options={backdropFade:!0,dialogFade:!0,keyboard:!0},this.showError=!1,this.error="",angular.extend(this.options,a)}return a.prototype.show=function(){return this.open=!0},a.prototype.hide=function(){return this.open=!1},a.prototype.throwError=function(a){return null==a&&(a=""),this.error=a,this.showError=!0},a.prototype.catchError=function(){return this.error="",this.showError=!1},a}()})}.call(this),function(){angular.module("pdifferenceApp").factory("Toolbelt",function(){var a;return a=function(){function a(a){this.session=a,this.active="move"}return a}()})}.call(this);